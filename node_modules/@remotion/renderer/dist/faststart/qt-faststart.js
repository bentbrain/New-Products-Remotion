"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.sortFaststartAtoms = exports.supportStreaming = void 0;
const atom_1 = require("./atom");
const update_chunk_offsets_1 = __importDefault(require("./update-chunk-offsets"));
function supportStreaming(infile) {
    const file = Buffer.from(infile);
    const atoms = (0, atom_1.parseAtoms)(file, 0, true);
    const mdatIndex = atoms.findIndex((atom) => atom.kind === 'mdat');
    const moovIndex = atoms.findIndex((atom) => atom.kind === 'moov');
    if (moovIndex === -1 || mdatIndex === -1) {
        return false;
    }
    return moovIndex < mdatIndex;
}
exports.supportStreaming = supportStreaming;
/**
 * Enables "faststart" for QuickTime files so that they can be streamed.
 *
 * @param infile QT/mp4 to faststart
 * @returns Faststarted QT/mp4
 */
function faststart(infile, options = {}) {
    const file = Buffer.from(infile);
    const atoms = (0, atom_1.parseAtoms)(file);
    console.log({ atoms });
    const mdatIndex = atoms.findIndex((atom) => atom.kind === 'mdat');
    if (mdatIndex === -1) {
        throw new Error(`No mdat atom found!`);
    }
    const moovIndex = atoms.findIndex((atom) => atom.kind === 'moov');
    if (moovIndex === -1) {
        throw new Error(`No moov atom found!`);
    }
    const faststarted = sortFaststartAtoms(atoms, options);
    return (0, atom_1.recurseFlattenAtoms)(faststarted);
}
exports.default = faststart;
/**
 * Sorts an array of QT atoms so that the first two atoms are `ftyp`, then `moov`.
 * Additionally updates all chunk offsets (`stco`/`co64` atoms) in `moov`.
 *
 * @param atoms QT atoms to sort
 */
function sortFaststartAtoms(atoms, options) {
    const faststarted = [];
    const ftyp = atoms.find((atom) => atom.kind === 'ftyp');
    if (!ftyp) {
        throw new Error('Missing ftyp atom!');
    }
    if (ftyp.size > atom_1.MAX_FTYP_ATOM_SIZE) {
        throw new Error(`ftyp atom is greater than ${atom_1.MAX_FTYP_ATOM_SIZE}`);
    }
    console.log('before', { atoms });
    const moov = atoms.find((atom) => atom.kind === 'moov');
    (0, update_chunk_offsets_1.default)(moov, options);
    faststarted.push(ftyp, moov);
    const rest = atoms.filter((atom) => !['ftyp', 'moov'].includes(atom.kind));
    faststarted.push(...rest);
    console.log('after', { faststarted });
    return faststarted;
}
exports.sortFaststartAtoms = sortFaststartAtoms;
